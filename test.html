<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Route from My Location on Hover</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://api.mapbox.com/mapbox-gl-js/v3.13.0/mapbox-gl.js"></script>
  <link href="https://api.mapbox.com/mapbox-gl-js/v3.13.0/mapbox-gl.css" rel="stylesheet" />
  <style>
    body { margin: 0; padding: 0; }
    #map { position: absolute; top: 0; bottom: 0; width: 100%; }
  </style>
</head>
<body>

<div id="map"></div>

<script>
  mapboxgl.accessToken = 'pk.eyJ1IjoiY2FzcGVyMjEiLCJhIjoiY21hdzV2OTZhMGIzNTJqcHU4d296NXR4NiJ9.CcTJpzheoL6YEbWXWXum2Q';

  const map = new mapboxgl.Map({
    container: 'map',
    style: 'mapbox://styles/mapbox/streets-v11',
    center: [121.540, 25.04],
    zoom: 13
  });

  const pointB = [121.5170, 25.0478];  // Taipei Main Station

  // Add marker for point B
  const markerB = new mapboxgl.Marker({ color: 'green' })
    .setLngLat(pointB)
    .addTo(map);

  let userLocation = null;

  // Get current location
  navigator.geolocation.getCurrentPosition(position => {
    userLocation = [position.coords.longitude, position.coords.latitude];

    // Add marker for user location
    new mapboxgl.Marker({ color: 'red' })
      .setLngLat(userLocation)
      .addTo(map);
  }, () => {
    alert("Unable to retrieve your location.");
  });

  let routeVisible = false;

  // Function to add route from user location to pointB
  function addRoute() {
    if (!userLocation) {
      console.log("User location not available yet.");
      return;
    }

    fetch(`https://api.mapbox.com/directions/v5/mapbox/walking/${userLocation[0]},${userLocation[1]};${pointB[0]},${pointB[1]}?geometries=geojson&access_token=${mapboxgl.accessToken}`)
      .then(response => response.json())
      .then(data => {
        const route = data.routes[0].geometry;

        // Add route source and layer
        if (!map.getSource('route')) {
          map.addSource('route', {
            'type': 'geojson',
            'data': {
              'type': 'Feature',
              'geometry': route
            }
          });

          map.addLayer({
            'id': 'route-layer',
            'type': 'line',
            'source': 'route',
            'layout': {
              'line-cap': 'round',
              'line-join': 'round'
            },
            'paint': {
              'line-color': '#1978c8',
              'line-width': 4
            }
          });

          routeVisible = true;
        }
      });
  }

  // Function to remove route
  function removeRoute() {
    if (routeVisible) {
      if (map.getLayer('route-layer')) map.removeLayer('route-layer');
      if (map.getSource('route')) map.removeSource('route');
      routeVisible = false;
    }
  }

  // Show route on hover
  markerB.getElement().addEventListener('mouseenter', () => {
    addRoute();
  });

  // Optionally hide route on mouseout
  markerB.getElement().addEventListener('mouseleave', () => {
    removeRoute();
  });
</script>

</body>
</html>
